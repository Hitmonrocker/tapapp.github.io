"use strict";StackExchange.tagEditor=function(e,t,n){function i(){E=!0}function a(){if("undefined"==typeof D){for(var e=StackExchange.tagEditor.requiredTags,t=[],n=0;n<e.length;n++)t.push(e[n].Name.replace(/[.+]/g,"\\$&"));D=new RegExp("^(?:"+t.join("|")+")$")}return D}function o(){var e=StackExchange.tagEditor.requiredTags;if(e&&/^ ?$/.test(_.val())){var t=a();0===q.add(L).children().filter(function(){return t.test($(this).text())}).length&&b(StackExchange.tagEditor.requiredTags)}}function r(e,t){var n=window.tagRendererRaw(e,null,"span"),i=$(n);return t||(i.append($("<span>",{"class":"delete-tag","title":"remove this tag"})),A.trigger("tagSpanCreated",[i])),i}function s(){var e=q.find(".post-tag").map(function(e,t){return $(t).text()}).get().join(" ");e.length&&(e+=" ");var t=L.find(".post-tag").map(function(e,t){return $(t).text()}).get().join(" ");return t.length&&_.val().length&&(t=" "+t),{"text":e+_.val()+t,"lengthBeforeInput":e.length}}function c(){var e=_.val();return(""===e||" "===e)&&0===q.add(L).children().filter(function(){return!/^\s*$/.test($(this).text())}).length}function l(){var e=_.caret();if(q.add(L).find(".post-tag").length){var t=s();_.val(t.text),q.empty(),L.empty(),_.caret(e.start+t.lengthBeforeInput,e.end+t.lengthBeforeInput),S()}}function u(t){if(!R){var n;if(n=t?{"start":_.val().length,"end":_.val().length}:_.caret(),-1==n.start&&(n.start=n.end=0),n.start!==n.end)return l(),h(),void 0;var i=_.val().substr(0,n.start),a=_.val().substr(n.start),c=(i+"!").split(/[,;\s]+/);c[c.length-1]="!"===c[c.length-1]?"":c[c.length-1].slice(0,-1);var u=a.split(/[,;\s]+/),d=c.pop(),f=d.length;d+=u.shift(),c=sanitizeAndSplitTags(c.join(" ")),u=sanitizeAndSplitTags(u.join(" "));var p;for(p=0;p<c.length;p++)r(c[p]).appendTo(q);for(p=0;p<u.length;p++)r(u[p]).appendTo(L);d!==_.val()&&_.val(d);var g={};A.find(".post-tag").filter(function(){var e=$(this).text();return/^\s*$/.test(e)?!0:g[e]===!0?!0:(g[e]=!0,!1)}).remove();var m=s().text;m!=e.val()&&e.val(m).trigger("change"),E&&(_.caret(f,f),w(),o()),h()}}function d(e,t){var n,i;if("string"==typeof e)i=e;else{if(!e.length)return;n=e,i=n.text()}for(var a=sanitizeAndSplitTags(_.val()),o=0;o<a.length;o++)r(a[o]).appendTo(q);if(_.val(i),n){var s=$($.unique(n.prevAll(".post-tag").get()));n.nextAll(".post-tag").prependTo(L),s.appendTo(q),n.remove()}else L.find(".post-tag").appendTo(q);_.focus(),t&&_.caret(0,0)}function f(e){var t=e.val(),n="c_"+t;if(n in F)return F[n];var i=$("<span />").css("font-family",e.css("font-family"));i.text(e.val()),i.insertAfter(e);var a=i.innerWidth();return i.remove(),F[n]=a,a}function p(e){e!==z&&(q.add(_).add(L).css({"position":"relative","left":e}),z=e)}function h(){var e=f(_)+19,t=q.outerWidth();return L.children().length||(e=Math.max(e,I-t-8)),_.css("width",e),t+z>0&&I>t+z+e?void 0:I>t+e?(p(0),void 0):(p(-t+(I-e)/2),void 0)}function g(){N=!0,setTimeout(function(){N=!1},0)}function m(e){if(e.shiftKey&&W[e.which]||e.ctrlKey&&65===e.which)return l(),!0;var t,n,i=_.caret().start,a=i===_.val().length,o=0===i;switch(e.which){case 37:return o?(d(q.find(".post-tag:last")),!1):!0;case 39:return a?(d(L.find(".post-tag:first"),!0),!1):!0;case 8:if(!o)return!0;if(t=q.find(".post-tag:last"),!t.length)return;return _.val(t.text()+_.val()),_.caret(t.text().length+i),t.remove(),!1;case 46:if(!a)return!0;if(n=L.find(".post-tag:first"),!n.length)return;return _.val(_.val()+n.text()),_.caret(i,i),n.remove(),!1;case 36:return t=q.find(".post-tag:first"),t.length?(d(t,!0),!1):!0;case 35:return n=L.find(".post-tag:last"),n.length?(d(n),!1):!0;case 40:return g(),$(".tag-suggestions > div:first").focus(),!1;case 9:g();break;case 27:S(),e.preventDefault(!0);break;case 13:if($(".tag-suggestions").length)return!1}return!0}function v(e){var t=e.find("p.more-info");"undefined"==typeof V&&(V=M-5-t.outerWidth());var n=e.find(".post-tag:first").outerWidth()+e.find(".item-multiplier").outerWidth();n>V&&t.find("a").text("info")}function b(e,t){$(".tag-suggestions").remove(),R=!1;var n=e.length;if(0!==n){var i=$("<div class='tag-suggestions' />").css({"position":"absolute","left":A.position().left,"top":A.position().top+O+1,"width":I-10}).insertAfter(A),a={};A.find(".post-tag").each(function(){a[$(this).text()]=!0});for(var o=0;o<e.length;o++)if(a[e[o].Name]!==!0){var r=x(e[o],t).appendTo(i).attr("tabindex",j||0);v(r),o%3===0&&r.css("clear","both")}i.delegate("div","keydown",C),i.delegate("div","click",function(e){$(e.target).is("a")||k($(this))}),i.delegate("div","focus",function(){N&&1===n?k($(this)):R=!0}),i.delegate("div","blur",function(){R=!1})}}function w(){var e=sanitizeAndSplitTags(_.val())[0];if(H!==e)return H=e,e&&e.length?(y(e,function(t){e===H&&E&&b(t,e)}),void 0):(S(),void 0)}function x(e,t){var n=$("<div />").css("width",M).data("tag-name",e.SynonymOf||e.Name);t&&(t=t.replace(/-/g,"").replace(/(.)(?=.)/g,"$1-*").replace(/\+/g,"\\+").replace(/\./g,"\\."));var i=r(e.Name,!0),a=i.html();t&&(a=a.replace(new RegExp("("+t+")"),"<span class='match'>$1</span>")),n.append(i.html(a)),e.Count&&n.append($("<span class='item-multiplier' />").html("&times;&nbsp;"+e.Count));var o="";if(e.Excerpt&&(o=e.Excerpt),o.length&&n.append($("<p />").text(o)),e.Synonyms&&e.Synonyms.length)for(var s=$("<p >also:</p>").appendTo(n),c=e.Synonyms.split(/\|/),l=0;l<c.length;l++)o=c[l],t&&(o=o.replace(new RegExp("("+t+")"),"<span class='match'>$1</span>")),l>0&&(o=", "+o),s.append("<span>"+o+"</span>");return n.append("<p class='more-info'><a href='/tags/"+encodeURIComponent(e.SynonymOf||e.Name)+"/info' target='_blank'>learn more</a></p>"),n}function y(e,t){J["t_"+e]?t(J["t_"+e]):Q.trigger(e,t)}function k(e){_.val(e.data("tag-name")),S(),d(""),u()}function S(){$(".tag-suggestions").remove(),R=!1,Q.cancel()}function C(e){var t;switch(e.which){case 39:case 40:return $(this).next("div").focus(),!1;case 37:return $(this).prev("div").focus(),!1;case 38:return t=$(this).prev("div"),t.length?t.focus():_.focus(),!1;case 27:return S(),_.focus(),!1;case 13:case 32:return k($(this)),!1}}var E;if("undefined"==typeof n)try{E=e.is(":focus")}catch(T){E=!1}else E=n;if(e.bind("focus",i),!e.is(":visible"))return t=t||0,3>t?(setTimeout(function(){e.unbind("focus",i),StackExchange.tagEditor(e,t+1,E)},300),void 0):(e.unbind("focus",i),$("body.review-task-page").length||StackExchange.debug.log("tag box is invisible, couldn't start tag editor"),void 0);e.unbind("focus",i);var I=e.innerWidth(),M=(I-40)/3|0,A=$("<div class='tag-editor' />").css("width",I).insertAfter(e);e.hide();var P=$("<span class='post-tag'>test</span>").appendTo(A),O=A.innerHeight();P.remove(),A.css("height",O);var q=$("<span />").appendTo(A),_=$("<input type='text' tabIndex='0'/>").appendTo(A).val(e.val()+" "),L=$("<span />").appendTo(A),j=e.attr("tabIndex");j&&_.attr("tabIndex",j);var D,R=!1,U=E;_.focus(function(t,n){E=!0,o(),U||(n||e.triggerHandler("focus",!0),U=!0)});var B=!1;A.mousedown(function(){B=!0,$(document).one("mouseup",function(){setTimeout(function(){E||(e.triggerHandler("blur"),U=!1),B=!1},0)})}),_.blur(function(){E=!1,setTimeout(function(){R||(S(),u(),B||(e.triggerHandler("blur"),U=!1)),B=!1},0)}),e.focus(function(e,t){t||_.trigger("focus",!0)}),_.keydown(m),_.bind("keydown paste click change",function(){setTimeout(function(){u()},0)}),A.delegate(".post-tag","click",function(e){var t=$(this);$(e.target).hasClass("delete-tag")&&t.text(""),d(t),u()}),A.click(function(e){e.target===this&&(d(""),u())}),A.on("rerender",function(){l(),u(!0)});var N,H,V,F={},z=0,W={"35":!0,"36":!0,"37":!0,"38":!0,"39":!0,"40":!0},J={},Q=StackExchange.helpers.DelayedReaction(function(e,t){StackExchange.helpers.addSpinner(A,{"position":"absolute","right":10,"top":O/2-2}),$.get("/filter/tags",{"q":e,"newstyle":!0},"json").done(function(n){J["t_"+e]=n,StackExchange.helpers.removeSpinner(),t(n)})},400,{"sliding":!0});u(!0),StackExchange.helpers.genericBindOverlayEvents(A,_,c),StackExchange.tagEditor.ready.resolve(),e[0].func_clear=function(){e.val(""),_.val("").blur(),A.find(".post-tag").remove()},e[0].func_add=function(e){var t=_.val();_.val(e),d(t),u()}},StackExchange.tagEditor.ready=$.Deferred();